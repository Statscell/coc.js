{"version":3,"file":"Tracker.js","sourceRoot":"","sources":["../../src/lib/Tracker.ts"],"names":[],"mappings":"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","sourcesContent":["import { handlePlayerChanges, handleClanChanges } from '../utils/events';\nimport { validateTag } from '../utils/utils';\nimport { Player, Clan } from './Client';\nimport { EventEmitter } from 'events';\nimport { CronJob } from 'cron';\nimport fetch from 'node-fetch';\n\nexport class Tracker extends EventEmitter {\n\n\tpublic tokens: string[];\n\tpublic events: string[];\n\tpublic apiUrl: string;\n\tpublic refreshRate: string;\n\n\tprivate playerList: string[] = [];\n\tprivate clanList: string[] = [];\n\tprivate activeToken = 0;\n\n\tprivate clanData = new Map();\n\tprivate playerData = new Map();\n\n\tpublic constructor(options: TrackerOptions) {\n\t\tsuper();\n\n\t\tthis.tokens = options.tokens;\n\t\tthis.events = options.events;\n\t\tthis.apiUrl = options.apiUrl || 'https://api.clashofclans.com/v1/';\n\t\tthis.refreshRate = options.refreshRate || '* 1 * * * *';\n\n\t\tif (this.tokens.length < 1) throw new Error('You must provided at least 1 token. Better provide multiple tokens to avoid rate limiting!');\n\t\tif (this.events.length < 1) throw new Error('No need to initialize a tracker if you are not willing to track any events!');\n\t}\n\n\tpublic addPlayers(playerTag: string | string[]) {\n\t\tconst list = Array.isArray(playerTag) ? playerTag : [playerTag];\n\t\tfor (const item of list) {\n\t\t\tconst tag = validateTag(item, false);\n\t\t\tif (tag) this.playerList.push(tag);\n\t\t}\n\t\treturn this;\n\t}\n\n\tpublic addClans(clanTag: string) {\n\t\tconst list = Array.isArray(clanTag) ? clanTag : [clanTag];\n\t\tfor (const item of list) {\n\t\t\tconst tag = validateTag(item, false);\n\t\t\tif (tag) this.clanList.push(tag);\n\t\t}\n\t\treturn this;\n\t}\n\n\tpublic removePlayers(playerTag: string | string[]) {\n\t\tconst list = Array.isArray(playerTag) ? playerTag : [playerTag];\n\t\tfor (const item of list) {\n\t\t\tconst tag = validateTag(item);\n\t\t\tif (tag) {\n\t\t\t\tconst index = this.playerList.indexOf(tag);\n\t\t\t\tif (index > -1) this.playerList = this.playerList.splice(index, 1);\n\t\t\t}\n\t\t}\n\t\treturn this;\n\t}\n\n\tpublic removeClans(clanTag: string | string[]) {\n\t\tconst list = Array.isArray(clanTag) ? clanTag : [clanTag];\n\t\tfor (const item of list) {\n\t\t\tconst tag = validateTag(item);\n\t\t\tif (tag) {\n\t\t\t\tconst index = this.clanList.indexOf(tag);\n\t\t\t\tif (index > -1) this.clanList = this.clanList.splice(index, 1);\n\t\t\t}\n\t\t}\n\t\treturn this;\n\t}\n\n\tpublic updateRefreshRate(rate: string) {\n\t\tthis.refreshRate = rate;\n\t\treturn this;\n\t}\n\n\tpublic start() {\n\t\tconst clanJob = new CronJob(this.refreshRate, () => {\n\t\t\tvoid this.trackClans();\n\t\t});\n\t\tconst playerJob = new CronJob(this.refreshRate, () => {\n\t\t\tvoid this.trackPlayers();\n\t\t});\n\t\tclanJob.start();\n\t\tplayerJob.start();\n\t}\n\n\tpublic get players() {\n\t\treturn this.playerList;\n\t}\n\n\tpublic get clans() {\n\t\treturn this.clanList;\n\t}\n\n\tprivate async trackPlayers() {\n\t\tfor (const player of this.playerList) {\n\t\t\tconst newData: Player = await fetch(`${this.apiUrl}players/%23${player}`, { headers: { Authorization: `Bearer ${this.token}` } })\n\t\t\t\t.then(res => res.json());\n\t\t\tconst oldData: Player = this.playerData.get(player);\n\t\t\tif (oldData) handlePlayerChanges(this, oldData, newData);\n\t\t\tthis.playerData.set(player, newData);\n\t\t}\n\t}\n\n\tprivate async trackClans() {\n\t\tfor (const clan of this.clanList) {\n\t\t\tconst newData: Clan = await fetch(`${this.apiUrl}clans/%23${clan}`, { headers: { Authorization: `Bearer ${this.token}` } })\n\t\t\t\t.then(res => res.json());\n\t\t\tconst oldData: Clan = this.clanData.get(clan);\n\t\t\tif (oldData) handleClanChanges(this, oldData, newData);\n\t\t\tthis.clanData.set(clan, newData);\n\t\t}\n\t}\n\n\tprivate get token() {\n\t\tconst token = this.activeToken >= this.tokens.length ? this.tokens[0] : this.tokens[this.activeToken];\n\t\tthis.activeToken += 1;\n\t\treturn token;\n\t}\n\n}\n\nexport interface TrackerOptions {\n\ttokens: string[];\n\tevents: event[];\n\tapiUrl?: string;\n\trefreshRate?: string;\n}\n\nexport type event = playerEvent | clanEvent;\n\ntype playerEvent = 'PLAYER_UPDATE' | 'PLAYER_TROOP_UPDATE' | 'PLAYER_ACHIEVEMENT_UPDATE';\ntype clanEvent = 'CLAN_UPDATE';\n/*\ntype warEvent = 'WAR_STATE_UPDATE' | 'WAR_ATTACK';\ntype clientEvent = 'MAINTENANCE_START' | 'MAINTENANCE_END';\n*/\n"]}